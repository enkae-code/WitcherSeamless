name: Build & Verify

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - "*"

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  clang-format:
    name: Clang-Format Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source with deps
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Validate formatting
        shell: bash
        run: |
          set -euo pipefail
          # Only look at our code, ignore the massive dependency folders
          FILES=$(git ls-files 'src/*.c' 'src/*.cpp' 'src/*.h' 'src/*.hpp')
          if [ -z "$FILES" ]; then
            echo "No C/C++ sources detected."
            exit 0
          fi
          clang-format --version
          echo "$FILES" | xargs -n 32 clang-format --dry-run --Werror

  build:
    name: Matrix Build
    needs: clang-format
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            preset: release
            artifact-label: windows
          - os: ubuntu-latest
            preset: release
            artifact-label: linux
    steps:
      - name: Checkout source with deps
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install CMake and Ninja
        uses: lukka/get-cmake@v3.29.5

      - name: Install build prerequisites (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build pkg-config

      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        uses: seanmiddleditch/gha-setup-ninja@v4

      - name: Enable MSVC environment
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1.13.0

      - name: Prime CMake cache
        uses: actions/cache@v5
        with:
          path: build/${{ matrix.preset }}
          key: cmake-${{ matrix.os }}-${{ matrix.preset }}-${{ hashFiles('CMakePresets.json', 'CMakeLists.txt', 'src/**/CMakeLists.txt') }}
          restore-keys: |
            cmake-${{ matrix.os }}-${{ matrix.preset }}-

      - name: Configure
        run: cmake --preset ${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }}

      - name: List build directory (Debug Windows)
        if: runner.os == 'Windows'
        run: dir /s build\release
        shell: cmd

      - name: List build directory (Debug Linux)
        if: runner.os == 'Linux'
        run: ls -R build/release
        shell: bash

      - name: Upload Windows Artifacts
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-windows
          path: build/**/*.dll # Finds W3m.dll anywhere in build/
          if-no-files-found: error

      - name: Upload Linux Artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-linux
          path: build/**/artifacts/* # Finds the Linux server artifacts
          if-no-files-found: error

  release:
    name: Draft Release (tagged builds)
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source with deps
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts-windows
          path: artifacts/windows

      - name: Assemble release payload
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $bundle = Join-Path $PWD 'release_bundle'
          New-Item -ItemType Directory -Force -Path $bundle | Out-Null
          
          # Robust search for the artifacts
          $dll = Get-ChildItem -Path "artifacts/windows" -Filter "scripting_experiments.dll" -Recurse | Select-Object -First 1
          $pdb = Get-ChildItem -Path "artifacts/windows" -Filter "scripting_experiments.pdb" -Recurse | Select-Object -First 1
          
          if ($null -eq $dll) { throw "Could not find scripting_experiments.dll in artifacts" }
          
          Copy-Item -Force $dll.FullName (Join-Path $bundle 'W3m.dll')
          if ($null -ne $pdb) {
              Copy-Item -Force $pdb.FullName (Join-Path $bundle 'W3m.pdb')
          }
          
          Copy-Item -Force -Recurse "src/scripts" (Join-Path $bundle 'scripts')
          Compress-Archive -Path (Join-Path $bundle '*') -DestinationPath "WitcherSeamless-${{ github.ref_name }}.zip" -Force

      - name: Publish draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: WitcherSeamless-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
